<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internals · Libtask</title><meta name="title" content="Internals · Libtask"/><meta property="og:title" content="Internals · Libtask"/><meta property="twitter:title" content="Internals · Libtask"/><meta name="description" content="Documentation for Libtask."/><meta property="og:description" content="Documentation for Libtask."/><meta property="twitter:description" content="Documentation for Libtask."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Libtask</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Libtask</a></li><li class="is-active"><a class="tocitem" href>Internals</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Internals</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internals</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TuringLang/Libtask.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TuringLang/Libtask.jl/blob/main/docs/src/internals.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Internals"><a class="docs-heading-anchor" href="#Internals">Internals</a><a id="Internals-1"></a><a class="docs-heading-anchor-permalink" href="#Internals" title="Permalink"></a></h1><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.produce_value" href="#Libtask.produce_value"><code>Libtask.produce_value</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">produce_value(x::Expr)</code></pre><p>Returns the value that a <code>produce</code> statement returns. For example, for the statment <code>produce(%x)</code>, this function will return <code>%x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L308-L313">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.is_produce_stmt" href="#Libtask.is_produce_stmt"><code>Libtask.is_produce_stmt</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_produce_stmt(x)::Bool</code></pre><p><code>true</code> if <code>x</code> is an expression of the form <code>Expr(:call, produce, %x)</code> or a similar <code>:invoke</code> expression, otherwise <code>false</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L263-L268">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.might_produce" href="#Libtask.might_produce"><code>Libtask.might_produce</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">might_produce(sig::Type{&lt;:Tuple})::Bool</code></pre><p><code>true</code> if a call to method with signature <code>sig</code> is permitted to contain <code>Libtask.produce</code> statements.</p><p>This is an opt-in mechanism. the fallback method of this function returns <code>false</code> indicating that, by default, we assume that calls do not contain <code>Libtask.produce</code> statements.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L242-L250">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.stmt_might_produce" href="#Libtask.stmt_might_produce"><code>Libtask.stmt_might_produce</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">stmt_might_produce(x, ret_type::Type)::Bool</code></pre><p><code>true</code> if <code>x</code> might contain a call to <code>produce</code>, and <code>false</code> otherwise.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L279-L283">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.LazyCallable" href="#Libtask.LazyCallable"><code>Libtask.LazyCallable</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L981-L983">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.inc_args" href="#Libtask.inc_args"><code>Libtask.inc_args</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">inc_args(stmt::T)::T where {T}</code></pre><p>Returns a new <code>T</code> which is equal to <code>stmt</code>, except any <code>Argument</code>s present in <code>stmt</code> are incremented by <code>1</code>. For example</p><pre><code class="language-julia-repl hljs">julia&gt; Libtask.inc_args(Core.ReturnNode(Core.Argument(1)))
:(return _2)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L327-L336">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.get_type" href="#Libtask.get_type"><code>Libtask.get_type</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_type(info::ADInfo, x)</code></pre><p>Returns the static / inferred type associated to <code>x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L368-L372">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask._typeof" href="#Libtask._typeof"><code>Libtask._typeof</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_typeof(x)</code></pre><p>Central definition of typeof, which is specific to the use-required in this package.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/copyable_task.jl#L359-L363">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.replace_captures" href="#Libtask.replace_captures"><code>Libtask.replace_captures</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">replace_captures(oc::Toc, new_captures) where {Toc&lt;:OpaqueClosure}</code></pre><p>Given an <code>OpaqueClosure</code> <code>oc</code>, create a new <code>OpaqueClosure</code> of the same type, but with new captured variables. This is needed for efficiency reasons – if <code>build_rrule</code> is called repeatedly with the same signature and intepreter, it is important to avoid recompiling the <code>OpaqueClosure</code>s that it produces multiple times, because it can be quite expensive to do so.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/utils.jl#L2-L10">source</a></section><section><div><pre><code class="language-julia hljs">replace_captures(mc::Tmc, new_captures) where {Tmc&lt;:MistyClosure}</code></pre><p>Same as <code>replace_captures</code> for <code>Core.OpaqueClosure</code>s, but returns a new <code>MistyClosure</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/utils.jl#L21-L25">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.BasicBlockCode" href="#Libtask.BasicBlockCode"><code>Libtask.BasicBlockCode</code></a> — <span class="docstring-category">Module</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">module BasicBlockCode</code></pre><p>Copied over from Mooncake.jl in order to avoid making this package depend on Mooncake. Refer to Mooncake&#39;s developer docs for context on this file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/bbcode.jl#L1-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.opaque_closure" href="#Libtask.opaque_closure"><code>Libtask.opaque_closure</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">opaque_closure(
    ret_type::Type,
    ir::IRCode,
    @nospecialize env...;
    isva::Bool=false,
    do_compile::Bool=true,
)::Core.OpaqueClosure{&lt;:Tuple, ret_type}</code></pre><p>Construct a <code>Core.OpaqueClosure</code>. Almost equivalent to <code>Core.OpaqueClosure(ir, env...; isva, do_compile)</code>, but instead of letting <code>Core.compute_oc_rettype</code> figure out the return type from <code>ir</code>, impose <code>ret_type</code> as the return type.</p><p><strong>Warning</strong></p><p>User beware: if the <code>Core.OpaqueClosure</code> produced by this function ever returns anything which is not an instance of a subtype of <code>ret_type</code>, you should expect all kinds of awful things to happen, such as segfaults. You have been warned!</p><p><strong>Extended Help</strong></p><p>This is needed because we make extensive use of our ability to know the return type of a couple of specific <code>OpaqueClosure</code>s without actually having constructed them. Without the capability to specify the return type, we have to guess what type <code>compute_ir_rettype</code> will return for a given <code>IRCode</code> before we have constructed the <code>IRCode</code> and run type inference on it. This exposes us to details of type inference, which are not part of the public interface of the language, and can therefore vary from Julia version to Julia version (including patch versions). Moreover, even for a fixed Julia version it can be extremely hard to predict exactly what type inference will infer to be the return type of a function.</p><p>Failing to correctly guess the return type can happen for a number of reasons, and the kinds of errors that tend to be generated when this fails tell you very little about the underlying cause of the problem.</p><p>By specifying the return type ourselves, we remove this dependence. The price we pay for this is the potential for segfaults etc if we fail to specify <code>ret_type</code> correctly.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/utils.jl#L123-L161">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.misty_closure" href="#Libtask.misty_closure"><code>Libtask.misty_closure</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">misty_closure(
    ret_type::Type,
    ir::IRCode,
    @nospecialize env...;
    isva::Bool=false,
    do_compile::Bool=true,
)</code></pre><p>Identical to <a href="#Libtask.opaque_closure"><code>opaque_closure</code></a>, but returns a <code>MistyClosure</code> closure rather than a <code>Core.OpaqueClosure</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/utils.jl#L184-L195">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.optimise_ir!" href="#Libtask.optimise_ir!"><code>Libtask.optimise_ir!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">optimise_ir!(ir::IRCode, show_ir=false)</code></pre><p>Run a fairly standard optimisation pass on <code>ir</code>. If <code>show_ir</code> is <code>true</code>, displays the IR to <code>stdout</code> at various points in the pipeline – this is sometimes useful for debugging.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/f00954a9877a1c17e9c6b95b30332ecfc3abbb12/src/utils.jl#L30-L35">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Libtask</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.1 on <span class="colophon-date" title="Tuesday 15 April 2025 12:55">Tuesday 15 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
