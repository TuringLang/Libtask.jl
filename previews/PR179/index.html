<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Libtask · Libtask</title><meta name="title" content="Libtask · Libtask"/><meta property="og:title" content="Libtask · Libtask"/><meta property="twitter:title" content="Libtask · Libtask"/><meta name="description" content="Documentation for Libtask."/><meta property="og:description" content="Documentation for Libtask."/><meta property="twitter:description" content="Documentation for Libtask."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href>Libtask</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>Libtask</a></li><li><a class="tocitem" href="internals/">Internals</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Libtask</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Libtask</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TuringLang/Libtask.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TuringLang/Libtask.jl/blob/main/docs/src/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Libtask"><a class="docs-heading-anchor" href="#Libtask">Libtask</a><a id="Libtask-1"></a><a class="docs-heading-anchor-permalink" href="#Libtask" title="Permalink"></a></h1><p>Libtask is best explained by the docstring for <a href="#Libtask.TapedTask"><code>TapedTask</code></a>:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.TapedTask" href="#Libtask.TapedTask"><code>Libtask.TapedTask</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">TapedTask(taped_globals::Any, f, args...; kwargs...)</code></pre><p>Construct a <code>TapedTask</code> with the specified <code>taped_globals</code>, for function <code>f</code>, positional arguments <code>args</code>, and keyword argument <code>kwargs</code>.</p><p><strong>Extended Help</strong></p><p>There are three central features of a <code>TapedTask</code>, which we demonstrate via three examples.</p><p><strong>Resumption</strong></p><p>The function <a href="#Libtask.produce"><code>Libtask.produce</code></a> has a special meaning in Libtask. You can insert it into regular Julia functions anywhere that you like. For example</p><pre><code class="language-julia-repl hljs">julia&gt; function f()
           for t in 1:2
               produce(t)
               t += 1
           end
           return nothing
       end
f (generic function with 1 method)</code></pre><p>If you construct a <code>TapedTask</code> from <code>f</code>, and call <a href="#Libtask.consume"><code>Libtask.consume</code></a> on it, you&#39;ll see</p><pre><code class="language-julia-repl hljs">julia&gt; t = TapedTask(nothing, f);

julia&gt; consume(t)
1</code></pre><p>The semantics of this are that <a href="#Libtask.consume"><code>Libtask.consume</code></a> runs the function <code>f</code> until it reaches the call to <a href="#Libtask.produce"><code>Libtask.produce</code></a>, at which point it will return the argument to <a href="#Libtask.produce"><code>Libtask.produce</code></a>.</p><p>Subsequent calls to <a href="#Libtask.produce"><code>Libtask.produce</code></a> will <em>resume</em> execution of <code>f</code> immediately after the last <a href="#Libtask.produce"><code>Libtask.produce</code></a> statement that was hit.</p><pre><code class="language-julia-repl hljs">julia&gt; consume(t)
2</code></pre><p>When there are no more <a href="#Libtask.produce"><code>Libtask.produce</code></a> statements to hit, calling <a href="#Libtask.consume"><code>Libtask.consume</code></a> will return <code>nothing</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; consume(t)
</code></pre><p><strong>Copying</strong></p><p><a href="#Libtask.TapedTask"><code>TapedTask</code></a>s can be copied. Doing so creates a completely independent object. For example:</p><pre><code class="language-julia-repl hljs">julia&gt; t2 = TapedTask(nothing, f);

julia&gt; consume(t2)
1</code></pre><p>If we make a copy and advance its state, it produces the same value that the original would have produced:</p><pre><code class="language-julia-repl hljs">julia&gt; t3 = copy(t2);

julia&gt; consume(t3)
2</code></pre><p>Moreover, advancing the state of the copy has not advanced the state of the original, because they are completely independent copies:</p><pre><code class="language-julia-repl hljs">julia&gt; consume(t2)
2</code></pre><p><strong>TapedTask-Specific Globals</strong></p><p>It is often desirable to permit a copy of a task and the original to differ in very specific ways. For example, in the context of Sequential Monte Carlo, you might want the only difference between two copies to be their random number generator.</p><p>A generic mechanism is available to achieve this. <a href="#Libtask.get_taped_globals"><code>Libtask.get_taped_globals</code></a> and <a href="#Libtask.set_taped_globals!"><code>Libtask.set_taped_globals!</code></a> let you set and retrieve a variable which is specific to a given <a href="#Libtask.TapedTask"><code>Libtask.TapedTask</code></a>. The former can be called inside a function:</p><pre><code class="language-julia-repl hljs">julia&gt; function f()
           produce(get_taped_globals(Int))
           produce(get_taped_globals(Int))
           return nothing
       end
f (generic function with 1 method)</code></pre><p>The first argument to <a href="#Libtask.TapedTask"><code>Libtask.TapedTask</code></a> is the value that <a href="#Libtask.get_taped_globals"><code>Libtask.get_taped_globals</code></a> will return:</p><pre><code class="language-julia-repl hljs">julia&gt; t = TapedTask(1, f);

julia&gt; consume(t)
1</code></pre><p>The value that it returns can be changed between <a href="#Libtask.consume"><code>Libtask.consume</code></a> calls:</p><pre><code class="language-julia-repl hljs">julia&gt; set_taped_globals!(t, 2)

julia&gt; consume(t)
2</code></pre><p><code>Int</code>s have been used here, but it is permissible to set the value returned by <a href="#Libtask.get_taped_globals"><code>Libtask.get_taped_globals</code></a> to anything you like.</p><p><strong>Implementation Notes</strong></p><p>Under the hood, we implement a <code>TapedTask</code> by obtaining the <code>IRCode</code> associated to the original function, transforming it so that it implements the semantics required by the <code>produce</code> / <code>consume</code> interface, and placing it inside a <code>MistyClosure</code> to make it possible to execute.</p><p>There are two main considerations when transforming the <code>IRCode</code>. The first is to ensure that the &quot;state&quot; of a <code>TapedTask</code> can be copied, so that a <code>TapedTask</code> can be copied, and resumed later. The complete state of a <code>TapedTask</code> is given by its arguments, and the value associated to each ssa (these are initially undefined). To make it possible to copy the state of the ssa values, we place a <code>Base.RefValue{T}</code>s into the captures of the <code>MistyClosure</code> which implements the <code>TapedTask</code>, one for each ssa in the IR (<code>T</code> is the type inferred for that ssa). A call is replaced by reading in values of ssas from these refs, applying the original operation, and writing the result to the ref associated to the instruction. For example, if the original snippet of <code>IRCode</code> is something like</p><pre><code class="language-julia hljs">%5 = f(%3, _1)</code></pre><p>the transformed IR would be something like</p><pre><code class="language-julia hljs">%5 = ref_for_%3[]
%6 = f(%5, _1)
     ref_for_%5[] = %6</code></pre><p>Setting things up in this manner ensures that an independent copy is made by simply copying all of the refs. A <code>deepcopy</code> is required for correctness as, while the refs to not alias one another (by construction), their contents might. For example, two refs may contain the same <code>Array</code>, and in general the behaviour of a function depends on this relationship.</p><p>The second component of the transformation is implementing the <code>produce</code> mechanism, and the ability to resume computation from where we produced. Roughly speaking, the <code>IRCode</code> must be modified to ensure that whenever a <code>produce</code> call in encountered, the <code>MistyClosure</code> returns the argument to <code>produce</code>, and that subsequent calls resume computation immediately after the <code>produce</code> statement. This resumption is achieved by setting the value of a counter prior to returning following a <code>produce</code> statement – a sequence of comparisons against this counter, and <code>goto-if-not</code> statement are inserted at the top of the IR. These are used to jump to the point in the code from which computation should resume. These are set up such that, when the <code>TapedTask</code> is first run, computation start froms the first statement. Observe that this is also facilitated by the ref mechanism discussed above, as it ensures that the state persists between calls to a <code>MistyClosure</code>.</p><p>The above gives the broad outline of how <code>TapedTask</code>s are implemented. We refer interested readers to the code, which is extensively commented to explain implementation details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L107-L268">source</a></section></article><p>The functions discussed in the above docstring (in addition to <a href="#Libtask.TapedTask"><code>TapedTask</code></a> itself) form the public interface of Libtask.jl. They divide neatly into two kinds of functions: those which are used to manipulate <a href="#Libtask.TapedTask"><code>TapedTask</code></a>s, and those which are intended to be used <em>inside</em> a <a href="#Libtask.TapedTask"><code>TapedTask</code></a>. First, manipulation of <a href="#Libtask.TapedTask"><code>TapedTask</code></a>s:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.consume" href="#Libtask.consume"><code>Libtask.consume</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">consume(t::TapedTask)</code></pre><p>Run <code>t</code> until it makes a call to <code>produce</code>. If this is the first time that <code>t</code> has been called, it starts execution from the entry point. If <code>consume</code> has previously been called on <code>t</code>, it will resume from the last <code>produce</code> call. If there are no more <code>produce</code> calls, <code>nothing</code> will be returned.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L327-L334">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Base.copy-Tuple{TapedTask}" href="#Base.copy-Tuple{TapedTask}"><code>Base.copy</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Base.copy(t::TapedTask)</code></pre><p>Makes a completely independent copy of <code>t</code>. <code>consume</code> can be applied to either the copy of <code>t</code> or the original without advancing the state of the other.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L319-L324">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.set_taped_globals!" href="#Libtask.set_taped_globals!"><code>Libtask.set_taped_globals!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">set_taped_globals!(t::TapedTask, new_taped_globals)::Nothing</code></pre><p>Set the <code>taped_globals</code> of <code>t</code> to <code>new_taped_globals</code>. Any calls to  <a href="#Libtask.get_taped_globals"><code>get_taped_globals</code></a> in future calls to <code>consume(t)</code> (either directly, or implicitly via iteration) will see this new value.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L307-L313">source</a></section></article><p>Functions for use inside a <a href="#Libtask.TapedTask"><code>TapedTask</code></a>s are:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.produce" href="#Libtask.produce"><code>Libtask.produce</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">produce(x)</code></pre><p>When run inside a <a href="#Libtask.TapedTask"><code>TapedTask</code></a>, will immediately yield to the caller, returning value <code>x</code>. Users will typically hit this function when calling <code>consume</code>.</p><p>See also: <a href="#Libtask.consume"><code>Libtask.consume</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L29-L36">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Libtask.get_taped_globals" href="#Libtask.get_taped_globals"><code>Libtask.get_taped_globals</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_taped_globals(T::Type)</code></pre><p>When called from inside a call to a <code>TapedTask</code>, this will return whatever is contained in its <code>taped_globals</code> field.</p><p>The type <code>T</code> is required for optimal performance. If you know that the result of this operation must return a specific type, specify <code>T</code>. If you do not know what type it will return, pass <code>Any</code> – this will typically yield type instabilities, but will run correctly.</p><p>See also <a href="#Libtask.set_taped_globals!"><code>set_taped_globals!</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/TuringLang/Libtask.jl/blob/47018b608576aad49918d91270e03b5c5ec69b65/src/copyable_task.jl#L1-L12">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="internals/">Internals »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.0 on <span class="colophon-date" title="Friday 9 May 2025 12:32">Friday 9 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
